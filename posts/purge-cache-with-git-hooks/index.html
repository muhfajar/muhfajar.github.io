<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Muhamad Fajar]"><meta name=description content="In the last post about deploying Now with Cloudflare, I have been describing in general how to deploy a project using Now and how to integrating with Cloudflare. After success deploying, if you set Cloudflare cache to make your website faster I guess you will face issue relate with a cache.
First, if you push or make changes, your website not instantly follow the changes. From my experience that because of cache!"><meta name=keywords content="muhamad fajar,cloud,tech,git,cloudflare"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://muhfajar.blog/posts/purge-cache-with-git-hooks/><title>Purge Cache with Git Hooks - Muhamad Fajar</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://muhfajar.blog/main.min.8361ed906e5fbdeb6e885a6576c6241b258b57a5d04cddd796d2edf04e08b632.css><link rel=apple-touch-icon sizes=180x180 href=https://muhfajar.blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://muhfajar.blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://muhfajar.blog/favicon-16x16.png><link rel=manifest href=https://muhfajar.blog/site.webmanifest><link rel=mask-icon href=https://muhfajar.blog/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=https://muhfajar.blog/favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Purge Cache with Git Hooks"><meta itemprop=description content="In the last post about deploying Now with Cloudflare, I have been describing in general how to deploy a project using Now and how to integrating with Cloudflare. After success deploying, if you set Cloudflare cache to make your website faster I guess you will face issue relate with a cache.
First, if you push or make changes, your website not instantly follow the changes. From my experience that because of cache!"><meta itemprop=datePublished content="2018-11-27T11:22:17+07:00"><meta itemprop=dateModified content="2020-05-02T13:50:07+07:00"><meta itemprop=wordCount content="361"><meta itemprop=image content="https://muhfajar.blog/"><meta itemprop=keywords content="cloud,tech,git,cloudflare,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://muhfajar.blog/"><meta name=twitter:title content="Purge Cache with Git Hooks"><meta name=twitter:description content="In the last post about deploying Now with Cloudflare, I have been describing in general how to deploy a project using Now and how to integrating with Cloudflare. After success deploying, if you set Cloudflare cache to make your website faster I guess you will face issue relate with a cache.
First, if you push or make changes, your website not instantly follow the changes. From my experience that because of cache!"><meta property="article:section" content="tech"><meta property="article:published_time" content="2018-11-27 11:22:17 +0700 WIB"></head><body><div class=container><header class="header no-print"><span class=header__inner><div class=logo><a href=../ style=text-decoration:none><span class=logo__mark>></span></a>
<a href=../ style=text-decoration:none><span class=logo__text>$ cd /root/</span>
<span class=logo__cursor></span></a></div><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://muhfajar.blog/>blog</a></li><li><a href=https://muhfajar.id/#contact>contact</a></li><li><a href=https://muhfajar.id/>home</a></li><li><a href=https://muhfajar.blog/resume>résumé</a></li><li class=hide-on-desktop><a href=https://muhfajar.blog/en/settings/>settings</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="settings-menu unselectable hide-on-phone hide-on-tablet"><a href=https://muhfajar.blog/en/settings/><svg class="setting-menu" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 0c-.883.0-1.742.102-2.57.283l.349 1.974c.715-.163 1.456-.257 2.221-.257 5.514.0 10 4.486 10 10 0 1.679-.421 3.26-1.154 4.65l-1.377-1.376c-.662-.661-1.002-1.581-.93-2.514.137-1.767-.471-3.58-1.82-4.93-1.225-1.224-2.825-1.83-4.428-1.83-.604.0-1.207.086-1.791.257l3.771 3.771c.408 1.889-2.33 4.66-4.242 4.242L6.258 10.5C6.086 11.084 6 11.688 6 12.292c0 1.602.607 3.202 1.83 4.426 1.35 1.351 3.164 1.958 4.93 1.821.934-.072 1.852.269 2.514.931l1.376 1.376c-1.391.734-2.971 1.154-4.65 1.154-5.514.0-10-4.486-10-10 0-1.914.551-3.697 1.489-5.217l2.173 2.173 1.353-7.014-7.015 1.35 2.037 2.038c-1.282 1.907-2.037 4.198-2.037 6.67.0 6.627 5.373 12 12 12s12-5.373 12-12-5.373-12-12-12z"/></svg></a></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 minutes</p></div><article><h1 class=post-title><a href=https://muhfajar.blog/posts/purge-cache-with-git-hooks/>Purge Cache with Git Hooks</a></h1><div class=cover-container><a href=https://muhfajar.blog/img/posts/purge-cache-with-git-hooks.jpg class="progressive replace post-cover"><img src=https://muhfajar.blog/img/posts/purge-cache-with-git-hooks.jpg alt=image class=preview></a>
<span class="post-cover__source hide-on-phone hide-on-tablet"><a href="https://wall.alphacoders.com/big.php?i=888391">source</a></span></div><div class=post-content><p>In the last post about <a href=https://muhfajar.blog/posts/deploying-now-with-cloudflare/>deploying Now with Cloudflare</a>, I have been describing in general how to deploy a project using Now and how to integrating with <a href=https://www.cloudflare.com/>Cloudflare</a>. After success deploying, if you set Cloudflare cache to make your website faster I guess you will face issue relate with a cache.</p><p>First, if you push or make changes, your website not instantly follow the changes. From my experience that because of cache! So to handle this case we need to purge every time we make a change and Git have a handy feature to make it automatically, they call hooks.</p><blockquote><p>Git hooks are scripts that Git executes before or after events such
as: commit, push, and receive. Git hooks are a built-in feature - no
need to download anything. Git hooks are run locally.<a href=https://githooks.com/>[1]</a></p></blockquote><p>To use this feature you only need to create a shell script and make it executable then put in hooks directory in .git on a project root. So that will be like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cd my_project/.git/hooks
touch pre-commit
chmod +x pre-commit
</code></pre></div><p>Inside file pre-commit, we can add shell script to call Cloudflare API like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>if</span> ! <span style=color:#f92672>[</span> -f ~/.cloudflare_config_muhfajar.blog <span style=color:#f92672>]</span> ; <span style=color:#66d9ef>then</span>
  echo <span style=color:#e6db74>&#34;No ~/.cloudflare_config_muhfajar.blog file found. Cloudflare clear cache SKIPPED.&#34;</span>
  exit <span style=color:#ae81ff>0</span>
<span style=color:#66d9ef>fi</span>

. ~/.cloudflare_config_muhfajar.blog

echo -n <span style=color:#e6db74>&#34;Clearing Cloudflare cache of muhfajar.id .....&#34;</span>

CF<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>curl -s -X DELETE <span style=color:#e6db74>&#34;https://api.cloudflare.com/client/v4/zones/</span>$CF_ID<span style=color:#e6db74>/purge_cache&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;X-Auth-Email: </span>$CF_EMAIL<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;X-Auth-Key: </span>$CF_API_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --data <span style=color:#e6db74>&#39;{&#34;purge_everything&#34;:true}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>echo $CF | grep success<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span> ; <span style=color:#66d9ef>then</span>
  echo <span style=color:#e6db74>&#34; Success!&#34;</span>
<span style=color:#66d9ef>else</span>
  echo <span style=color:#e6db74>&#34; *** FAILED ***&#34;</span>
  echo <span style=color:#e6db74>&#34;Could not clear cloudflare&#39;s cache. Update will not proceed.&#34;</span>
  <span style=color:#75715e># exit with 1, so the update does not proceed, so we will know</span>
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>
</code></pre></div><p>As you can see, that have separated config file, to make the script work, we also need to create a configuration file in the user directory.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cd ~
touch .cloudflare_config_muhfajar.blog
</code></pre></div><p>And add detail about Cloudflare configuration</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>CF_API_KEY=some-api-key-from-cloudflare
CF_EMAIL=your.email.registered.in.cloudflare@foo.com
CF_ID=cloudflare-zone-id
</code></pre></div><p>To generate an API key in Cloudflare, please refer to this <a href=https://developers.cloudflare.com/api/tokens/create>link</a>. After all complete, now you can deploy and also tell Cloudflare to purge your cache, so your web visitor always gets the latest data.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://muhfajar.blog/tags/cloud>cloud</a></span><span class=tag><a href=https://muhfajar.blog/tags/tech>tech</a></span><span class=tag><a href=https://muhfajar.blog/tags/git>git</a></span><span class=tag><a href=https://muhfajar.blog/tags/cloudflare>cloudflare</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>361 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-11-27 11:22 +0700</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/muhfajar/blog/commit/0d9494f9a0abe96f82bd45ff2874669e8792aaca target=_blank rel=noopener>0d9494f</a> @ 2020-05-02</p></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"muhfajar-id"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class="footer no-print"><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://muhfajar.blog/>Muhamad Fajar</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://muhfajar.blog/posts/index.xml target=_blank title=rss>rss</a></span></div></div></footer></div><script type=text/javascript src=https://muhfajar.blog/bundle.min.dbfa50ac3ed74cd0faf8f447ad6d0305647f912bd106c72c7b74af360b4d270c5719304dd712b9cbcafb4ea6558e8fadaca8b42f0d0f7d9d67f98144af876442.js integrity="sha512-2/pQrD7XTND6+PRHrW0DBWR/kSvRBscse3SvNgtNJwxXGTBN1xK5y8r7TqZVjo+trKi0Lw0PfZ1n+YFEr4dkQg=="></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','G-LX569461TH','auto');ga('send','pageview');</script></body></html>